#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit hooks..."

# Performance check start time
start_time=$(date +%s)

# Run lint-staged for file-specific checks
echo "ğŸ“ Running lint-staged checks..."
npx lint-staged

# Type checking
echo "ğŸ”§ Running TypeScript type checking..."
npm run type-check

# Run tests with coverage check
echo "ğŸ§ª Running tests with coverage..."
npm run test:coverage -- --passWithNoTests --silent

# Performance benchmarks for critical changes
if git diff --cached --name-only | grep -E "(utils|hooks|components)" > /dev/null; then
  echo "âš¡ Running performance benchmarks..."
  npm run test:performance -- --silent
fi

# Bundle size check
echo "ğŸ“¦ Checking bundle size impact..."
npm run build > /dev/null 2>&1
if [ -f "dist/stats.json" ]; then
  node -e "
    const fs = require('fs');
    try {
      const stats = JSON.parse(fs.readFileSync('dist/stats.json', 'utf8'));
      const totalSize = stats.assets.reduce((sum, asset) => sum + asset.size, 0);
      const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);
      console.log(\`ğŸ“Š Current bundle size: \${sizeInMB}MB\`);

      // Warn if bundle is too large
      if (totalSize > 5 * 1024 * 1024) { // 5MB
        console.warn('âš ï¸  Bundle size is large. Consider code splitting.');
      }
    } catch (e) {
      console.log('Bundle analysis skipped');
    }
  "
fi

# Accessibility check for component changes
if git diff --cached --name-only | grep -E "components.*\.(tsx?|jsx?)$" > /dev/null; then
  echo "â™¿ Running accessibility checks..."
  npm run test:a11y -- --silent
fi

# Security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high --silent

# Performance timing
end_time=$(date +%s)
duration=$((end_time - start_time))

echo "âœ… Pre-commit checks completed in ${duration}s"

# Warn if pre-commit took too long
if [ $duration -gt 30 ]; then
  echo "âš ï¸  Pre-commit hooks took longer than expected (${duration}s)"
  echo "ğŸ’¡ Consider optimizing your staged changes"
fi

echo "ğŸš€ Ready to commit!"
